<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Using Proxy for SSH | AllenY&#39;s blog</title>
<link rel="shortcut icon" href="https://alleny.xyz/favicon.ico?v=1747120786321">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://alleny.xyz/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Using Proxy for SSH | AllenY&#39;s blog - Atom Feed" href="https://alleny.xyz/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">


<script async src="https://www.googletagmanager.com/gtag/js?id=G-HPLP8D1S43"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HPLP8D1S43');
</script>


    <meta name="description" content="å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨sshè¿æ¥å›½å¤–çš„æœåŠ¡å™¨ï¼Œä¼šè¢«GFWæ£€æµ‹å‡ºï¼Œå‡ºç°å¹²æ‰°ã€ä¸¢åŒ…ç­‰é—®é¢˜ã€‚å› æ­¤ä½¿ç”¨proxyè¿›è¡Œsshè¿æ¥å˜å¾—å¾ˆæœ‰å¿…è¦ã€‚

èƒŒæ™¯
æœ€è¿‘åœ¨ä½¿ç”¨Utahçš„Cloudlabï¼Œç”±äºæä¾›çš„æœåŠ¡å™¨éƒ¨ç½²åœ¨ç¾å›½ï¼Œåœ¨ä½¿ç”¨sshè¿æ¥æ—¶ä¼šç»å¸¸æ–­æ‰ï¼Œç”šè‡³é•¿æ—¶..." />
    <meta name="keywords" content="Technical Sharing" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://alleny.xyz">
  <img class="avatar" src="https://alleny.xyz/images/avatar.png?v=1747120786321" alt="">
  </a>
  <h1 class="site-title">
    AllenY&#39;s blog
  </h1>
  <p class="site-description">
    ğŸ§‘ğŸ»â€ğŸ’»ğŸ®ğŸ¿ğŸ¹ğŸ—»
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Home
        </a>
      
    
      
        <a href="/archives" class="menu">
          Archive
        </a>
      
    
      
        <a href="/tags" class="menu">
          Tags
        </a>
      
    
      
        <a href="/post/about" class="menu">
          About
        </a>
      
    
  </div>
  <div class="social-container">
    
      
        <a href="https://github.com/Yuan-Allen" target="_blank">
          <i class="ri-github-line"></i>
        </a>
      
    
      
    
      
        <a href="https://weibo.com/u/6478080851" target="_blank">
          <i class="ri-weibo-line"></i>
        </a>
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Using Proxy for SSH
            </h2>
            <div class="post-info">
              <span>
                2023-03-01
              </span>
              <span>
                6 min read
              </span>
              
                <a href="https://alleny.xyz/tag/WT-UATSMl/" class="post-tag">
                  # Technical Sharing
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://alleny.xyz/post-images/ssh-over-proxy.jpg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <p>å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨sshè¿æ¥å›½å¤–çš„æœåŠ¡å™¨ï¼Œä¼šè¢«GFWæ£€æµ‹å‡ºï¼Œå‡ºç°å¹²æ‰°ã€ä¸¢åŒ…ç­‰é—®é¢˜ã€‚å› æ­¤ä½¿ç”¨proxyè¿›è¡Œsshè¿æ¥å˜å¾—å¾ˆæœ‰å¿…è¦ã€‚</p>
<!-- more -->
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>æœ€è¿‘åœ¨ä½¿ç”¨<a href="https://www.utah.edu/">Utah</a>çš„<a href="https://www.cloudlab.us/">Cloudlab</a>ï¼Œç”±äºæä¾›çš„æœåŠ¡å™¨éƒ¨ç½²åœ¨ç¾å›½ï¼Œåœ¨ä½¿ç”¨sshè¿æ¥æ—¶ä¼šç»å¸¸æ–­æ‰ï¼Œç”šè‡³é•¿æ—¶é—´è¿æ¥ä¸ä¸Šï¼Œå¯¹å·¥ä½œå½¢æˆäº†å¾ˆå¤§çš„å¹²æ‰°ï¼Œäºæ˜¯èŒç”Ÿäº†è®©sshèµ°proxyçš„æƒ³æ³•ã€‚</p>
<h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2>
<ul>
<li>ç³»ç»Ÿï¼šmacOS 13.2.1 (22D68)</li>
<li>ssh version: OpenSSH_9.0p1, LibreSSL 3.3.6</li>
<li>ä½¿ç”¨çš„proxyæ–¹æ¡ˆï¼šClashX (Version 1.96.2) &amp; æœºåœº</li>
</ul>
<h2 id="åšæ³•">åšæ³•</h2>
<h3 id="å‘½ä»¤">å‘½ä»¤</h3>
<p>æŸ¥è¯¢èµ„æ–™ï¼Œå¾—åˆ°ä½¿ç”¨ä»£ç†çš„sshå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">ssh -o ProxyCommand=&quot;nc -X 5 -x 127.0.0.1:7890 %h %p&quot; user@server
</code></pre>
<h3 id="å‚æ•°è§£é‡Š">å‚æ•°è§£é‡Š</h3>
<h4 id="ç¿»çœ‹æ–‡æ¡£">ç¿»çœ‹æ–‡æ¡£</h4>
<blockquote>
<p>å¤ªé•¿ä¸çœ‹å¯ä»¥è·³åˆ°<a href="#%E6%80%BB%E7%BB%93">å‚æ•°æ€»ç»“</a></p>
</blockquote>
<p><code>man ssh</code>ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ç›¸å…³å‚æ•°ä¿¡æ¯ï¼š</p>
<pre><code>-o option
             Can be used to give options in the format used in the
             configuration file.  This is useful for specifying options for
             which there is no separate command-line flag.  For full details
             of the options listed below, and their possible values, see
             ssh_config(5).
</code></pre>
<p><code>man ssh_config</code>ï¼Œå¾—åˆ°ï¼š</p>
<pre><code>ProxyCommand
             Specifies the command to use to connect to the server.  The
             command string extends to the end of the line, and is executed
             using the user's shell â€˜execâ€™ directive to avoid a lingering
             shell process.

             Arguments to ProxyCommand accept the tokens described in the
             TOKENS section.  The command can be basically anything, and
             should read from its standard input and write to its standard
             output.  It should eventually connect an sshd(8) server running
             on some machine, or execute sshd -i somewhere.  Host key
             management will be done using the Hostname of the host being
             connected (defaulting to the name typed by the user).  Setting
             the command to none disables this option entirely.  Note that
             CheckHostIP is not available for connects with a proxy command.

             This directive is useful in conjunction with nc(1) and its proxy
             support.  For example, the following directive would connect via
             an HTTP proxy at 192.0.2.0:

                ProxyCommand /usr/bin/nc -X connect -x 192.0.2.0:8080 %h %p
</code></pre>
<p><code>man nc</code>ï¼š</p>
<pre><code>-X proxy_version
             Requests that nc should use the specified protocol when talking
             to the proxy server.  Supported protocols are â€œ4â€ (SOCKS v.4),
             â€œ5â€ (SOCKS v.5) and â€œconnectâ€ (HTTPS proxy).  If the protocol is
             not specified, SOCKS version 5 is used.

-x proxy_address[:port]
             Requests that nc should connect to hostname using a proxy at
             proxy_address and port.  If port is not specified, the well-known
             port for the proxy protocol is used (1080 for SOCKS, 3128 for
             HTTPS).
</code></pre>
<h4 id="æ€»ç»“">æ€»ç»“ï¼š</h4>
<ul>
<li><code>-o</code>å‚æ•°ç”¨äºæä¾›é…ç½®é€‰é¡¹ã€‚</li>
<li><code>ProxyCommand</code>æŒ‡å®šç”¨äºè¿æ¥Serverçš„å‘½ä»¤ã€‚</li>
<li><code>nc</code>æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¥åœ¨ç½‘ç»œä¸Šè¯»å†™æ•°æ®çš„å‘½ä»¤è¡Œå·¥å…·ã€‚
<ul>
<li><code>-X</code>æŒ‡å®šä¸proxyä½¿ç”¨çš„protocolï¼Œ4ä»£è¡¨SOCKS V.4ï¼Œ5ä»£è¡¨SOCKS v.5ï¼Œconnectä»£è¡¨ä½¿ç”¨HTTPS proxyã€‚å®é™…ä¸Šï¼Œè¯¥å‚æ•°çš„é»˜è®¤å€¼æ˜¯5ã€‚</li>
<li><code>-x</code>æŒ‡å®šproxyçš„addrä¸portã€‚</li>
</ul>
</li>
</ul>
<p>ç”±äºä½¿ç”¨çš„æ˜¯ClashXï¼Œé»˜è®¤çš„æ··åˆä»£ç†ç«¯å£ä¸º7890ã€‚åœ¨ä½¿ç”¨æ—¶ï¼Œè¯·æ ¹æ®ä½ çš„å®é™…æƒ…å†µå¡«å†™ä»£ç†ç«¯å£ã€‚</p>
<h2 id="è¿™å°±ç»“æŸäº†">è¿™å°±ç»“æŸäº†ï¼Ÿ</h2>
<p>å¦‚æœä½ åœ¨Googleæœç´¢â€œå¦‚ä½•è®©sshèµ°ä»£ç†â€ï¼Œé‚£ä¹ˆæ•™ç¨‹å¤šåŠåœ¨ä½ å¾—åˆ°<a href="#%E5%91%BD%E4%BB%A4">è¿™æ¡å‘½ä»¤</a>åå°±ç»“æŸäº†ã€‚äºæ˜¯ä½ å…´å†²å†²çš„å»terminalå°è¯•ï¼Œç»“æœè¢«ç°å®ç‹ ç‹ æ‰“è„¸ï¼š</p>
<pre><code>kex_exchange_identification: Connection closed by remote host
Connection closed by UNKNOWN port 65535
</code></pre>
<p>å¯æ˜¯ä½ å·²ç»åœ¨ç½‘ä¸Šæ‰¾äº†å„ç§â€œå¦‚ä½•è®©sshèµ°ä»£ç†â€çš„æ•™ç¨‹ï¼Œä½ å‘ç°å¾—åˆ°çš„å†…å®¹ä¸ä¸Šé¢çš„å‘½ä»¤éƒ½åˆ«æ— äºŒè‡´ã€‚é‚£ä¹ˆç©¶ç«Ÿæ˜¯å“ªé‡Œå‡ºé”™äº†ï¼Ÿ</p>
<h3 id="å›åˆ°ç«¯å£">å›åˆ°ç«¯å£</h3>
<p>ç”±äº<a href="https://www.ssh.com/academy/ssh/port">å†å²åŸå› </a>ï¼Œsshçš„é»˜è®¤ç«¯å£ä¸º22ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯æœºåœºä»£ç†ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½æ˜¯æœºåœºç”±äºè‡ªèº«åŸå› å…³é—­äº†22ç«¯å£ã€‚<br>
ç½‘ä¸Šå…³äºä¸Šè¿°æŠ¥é”™çš„åœºæ™¯å¤šåœ¨äºè®¿é—®Githubä»“åº“å¤±è´¥ï¼Œ<a href="https://docs.github.com/en/authentication/troubleshooting-ssh/using-ssh-over-the-https-port">è§£å†³æ–¹æ¡ˆä¸ºæ”¹ä¸ºä½¿ç”¨443ç«¯å£è®¿é—®ssh.github.com</a>ã€‚å¦‚æœä½ æƒ³è®¿é—®çš„å°±æ˜¯Githubï¼Œé‚£ä¹ˆè¿™æˆ–è®¸èƒ½è§£å†³ä½ çš„é—®é¢˜ã€‚<br>
ä½†å¾ˆé—æ†¾ï¼Œæˆ‘è®¿é—®çš„ä¸æ˜¯Githubï¼Œå¹¶ä¸èƒ½ç›´æ¥ç”¨443ç«¯å£å»sshè¿æ¥è¿œç¨‹çš„æœåŠ¡å™¨ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•ï¼šä¿®æ”¹è¿œç¨‹æœåŠ¡å™¨çš„sshç«¯å£ã€‚</p>
<h3 id="ä¿®æ”¹sshç«¯å£">ä¿®æ”¹sshç«¯å£</h3>
<p>è¿›å…¥æœåŠ¡å™¨ï¼Œæ‰“å¼€<code>/etc/ssh/sshd_config</code>ï¼Œæ‰¾åˆ°</p>
<pre><code>#Port 22
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::
</code></pre>
<p>è¿™é‡Œ<code>Port 22</code>è¢«æ³¨é‡Šæ‰ï¼Œå› ä¸ºåŸæœ¬22å°±æ˜¯é»˜è®¤ç«¯å£ã€‚å°†è¿™é‡Œä¿®æ”¹ä¸º</p>
<pre><code>Port 22
Port 10022
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::
</code></pre>
<p>è¿™é‡Œ10022ä»…åšç¤ºä¾‹ï¼Œä½ å¯ä»¥ä¿®æ”¹ä¸ºä½ æƒ³è¦è®¾ç½®çš„å…¶ä»–ç«¯å£ï¼Œä½†æ˜¯è¯·æ³¨æ„ç«¯å£ä¸è¦å†²çªã€‚22ç«¯å£åŒæ ·æ‰“å¼€ï¼Œè¿™æ ·ä½ å¯ä»¥åŒæ—¶åœ¨è¿™ä¸¤ä¸ªç«¯å£ä¸­é€‰æ‹©ä½¿ç”¨è¿›è¡Œsshè¿æ¥ã€‚<br>
é‡å¯sshæœåŠ¡ï¼š</p>
<pre><code class="language-shell">sudo systemctl restart sshd
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å°†<a href="#%E5%91%BD%E4%BB%A4">å‘½ä»¤</a>ä¿®æ”¹æˆå¦‚ä¸‹</p>
<pre><code>ssh -o ProxyCommand=&quot;nc -X 5 -x 127.0.0.1:7890 %h %p&quot; user@server -p 10022
</code></pre>
<p>æŒ‡å®šäº†10022ç«¯å£ï¼Œå‘ç°è¿æ¥æˆåŠŸï¼</p>
<h3 id="vs-code">VS code</h3>
<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯<a href="https://code.visualstudio.com/">VS code</a>ï¼Œä½ å¯ä»¥åœ¨<code>~/.ssh/config</code>ä¸­ä½œå¦‚ä¸‹é…ç½®ï¼š</p>
<pre><code>Host server
  HostName server
  User user
  Port 10022
  ProxyCommand nc -X 5 -x 127.0.0.1:7890 %h %p
</code></pre>
<p>æ³¨æ„è¿™é‡Œ<code>Port</code>ä¸<code>ProxyCommand</code>çš„è®¾ç½®ã€‚</p>
<h2 id="æ€»ç»“-2">æ€»ç»“</h2>
<p>ç”±äºéœ€è¦è¿æ¥åˆ°å›½å¤–çš„æœåŠ¡å™¨ï¼Œä¸ºäº†sshè¿æ¥çš„ç¨³å®šæ€§ï¼Œæˆ‘ä»¬æƒ³åˆ°ä½¿ç”¨ä»£ç†æ¥ååŠ©sshè¿æ¥ã€‚æ ¹æ®æŸ¥æ‰¾èµ„æ–™ï¼Œæˆ‘ä»¬å¾—åˆ°äº†è®©sshä½¿ç”¨æœ¬æœºClashXä»£ç†çš„å‘½ä»¤ã€‚ä½†æ˜¯ä»£ç†æä¾›å•†å¯èƒ½ä¼šæŠŠ22ç«¯å£å°æ‰ï¼Œå¯¼è‡´è¿æ¥å¤±è´¥ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æœåŠ¡å™¨çš„sshç«¯å£ï¼Œç„¶åé‡æ–°ç”¨æ–°çš„ç«¯å£è¿›è¡Œè¿æ¥ã€‚å¦‚æœä½¿ç”¨VS codeè¿›è¡Œè¿œç¨‹è¿æ¥ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹<code>.ssh</code>ç›®å½•ä¸‹çš„configæ–‡ä»¶ä»è€Œä¸ç”¨åå¤è¾“å…¥å‘½ä»¤ã€‚</p>
<p>Done!</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E8%83%8C%E6%99%AF">èƒŒæ™¯</a></li>
<li><a href="#%E7%8E%AF%E5%A2%83">ç¯å¢ƒ</a></li>
<li><a href="#%E5%81%9A%E6%B3%95">åšæ³•</a>
<ul>
<li><a href="#%E5%91%BD%E4%BB%A4">å‘½ä»¤</a></li>
<li><a href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A">å‚æ•°è§£é‡Š</a>
<ul>
<li><a href="#%E7%BF%BB%E7%9C%8B%E6%96%87%E6%A1%A3">ç¿»çœ‹æ–‡æ¡£</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“ï¼š</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E8%BF%99%E5%B0%B1%E7%BB%93%E6%9D%9F%E4%BA%86">è¿™å°±ç»“æŸäº†ï¼Ÿ</a>
<ul>
<li><a href="#%E5%9B%9E%E5%88%B0%E7%AB%AF%E5%8F%A3">å›åˆ°ç«¯å£</a></li>
<li><a href="#%E4%BF%AE%E6%94%B9ssh%E7%AB%AF%E5%8F%A3">ä¿®æ”¹sshç«¯å£</a></li>
<li><a href="#vs-code">VS code</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93-2">æ€»ç»“</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        

        
          

          
            <link rel="stylesheet" href="https://unpkg.com/disqusjs@1.1/dist/disqusjs.css">
<script src="https://unpkg.com/disqusjs@1.1/dist/disqus.js"></script>

<div id="disqus_thread"></div>

<script>

var options = {
  shortname: 'alleny-blog',
  apikey: '2kPJh2tQ0rWB7n0QOhvb9TLbm946tHMWCixW2qGF9j8tfMBgZoNPfvLpDoxZTZpD',
}
if ('https://disqus.hangyu-yuan.workers.dev/api/') {
  options.api = 'https://disqus.hangyu-yuan.workers.dev/api/'
}
var dsqjs = new DisqusJS(options)

</script>

          
        

        <div class="site-footer">
  Copyright Â© 2023-2025 Allen Yuan. All rights reserved.
  <a class="rss" href="https://alleny.xyz/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
